% vim: set textwidth=78 autoindent:
% !TeX root = user_guide.tex 

\chapter{Arbeiten mit Rasterdaten}\label{label_raster}
\index{Rasterlayer|(}

% when the revision of a chapter has been finalized, 
% comment out the following line:
%\updatedisclaimer

Dieses Kapitel beschreibt, wie Rasterlayer visualisiert und ihre
Eigenschaften (Darstellung, Farben, Kanäle) festgelegt werden können. 
QGIS benutzt die GDAL-Bibliothek, um Vektorformate zu lesen und zu schreiben.
\footnote{GRASS Rastersupport wird durch einen eigenen QGIS Datenprovider 
bereitgestellt.} Unterstützt werden eine Vielzahl von Rasterformaten
\index{Rasterlayer!Datenformate}, wie Arc/Info Binary Grid
\index{Rasterlayer!Arc/Info Binary Grid}, GeoTIFF
\index{Rasterlayer!GeoTIFF} oder ERDAS Img
\index{Rasterlayer!ERDAS Img}.

Aktuell werden mehr als 100 Rasterformate durch die GDAL-Bibliothek 
unterstützt. Sie finden eine komplette Liste unter der URL 
\url{http://www.gdal.org/formats_list.html}.

\textbf{Note}: Einige der aufgelisteten Formate können auf ihrem Rechner aus unterschiedlichen Gründen nicht unterstützt werden. Einige brauchen z.B. 
kommerzielle Bibliotheken oder die GDAL Installation auf Ihrem Rechner, wurde 
ohne die Unterstützung für das entsprechende Format erstellt. Nur Formate, die 
getestet wurden, können ausgewählt werden, wenn Sie eine Rasterdatei in QGIS 
laden. Alle anderen werden angezeigt, wenn Sie *.* auswählen.

Das Arbeiten mit GRASS Rasterdaten wird in Kapitel \ref{sec:grass} vorgestellt.

\section{Was ist ein Rasterlayer?}\label{label_whatsraster}
\index{Rasterlayer!Definition}

Rasterlayer in QGIS sind Gitter aus diskreten Zellen oder Pixeln, die Objekte
über, auf oder unter der Erdoberfläche beschreiben. Jede Zelle eines Rasters
hat die gleiche Größe und ist meistens rechteckig (in QGIS ist dies immer so).
Typische Rasterlayer sind Fernerkungsdaten wie Luft- oder Satellitenbilddaten
oder modellierte Daten wie Höhenmodelle.

Im Gegensatz zu Vektorlayern haben Rasterlayer keine Verknüpfung zu einer
Attributtabelle mit Werten für jede Zelle.

In Geographischen Informationssystemen (GIS) ist ein Raster eine
georeferenzierte Datei mit Informationen, die räumlich korrekt mit anderen
Vektorlayern oder Rasterdaten überlagert werden kann. QGIS liest dazu die 
Projektionsinformationen innerhalb des Rasterlayers (e.g. GeoTiff) oder aus
einem passenden Worldfile.\index{Rasterlayer!Georeferenziert}

QGIS kann Rasterlayer also korrekt visualisieren aber bisher nur
eingeschränkt analysieren.

\section{Rasterlayer in QGIS laden}\label{label_loadraster}

Rasterlayer können durch klicken auf das
\toolbtntwo{mActionAddRasterLayer}{Raster hinzufügen} Icon oder über die
Menüleiste unter
\mainmenuopt{View} \arrow \dropmenuopttwo{mActionAddRasterLayer}{Raster hinzufügen}
geladen werden. Mehrere Raster können gleichzeitig geladen werden, indem die
\keystroke{Control}- oder \keystroke{Umschalt}-Taste während der Auswahl der
Layer im Dialog \dialog{Öffnen einer GDAL Rasterquelle} gedrückt
gehalten wird.\index{Rasterlayer!Offnen}

\section{Rasterlayereigenschaften}\label{label_rasterprop}

Um die Darstellung des Rasterlayers anzusehen oder anzupassen, klicken Sie
mit der rechten Maustaste auf den Layernamen in der Legende. Dadurch
erscheint ein Menü und bietet eine Vielzahl von
Optionen:\index{Rasterlayer!Layereigenschaften}

\minisec{Rechte-Maustaste Menü für Rasterlayer}

\begin{itemize}[label=--]
\item \dropmenuopt{Auf die Layerausdehnung zoomen}
\item \dropmenuopt{Auf besten Maßstab zoomen (100\%)}
\item \dropmenuopt{In der Übersicht anzeigen}
\item \dropmenuopt{Entfernen}
\item \dropmenuopt{KBS für Layer setzen}
\item \dropmenuopt{Layer-KBS dem Projekt zuweisen}
\item \dropmenuopt{Eigenschaften}
\item \dropmenuopt{Umbenennen}
\item \dropmenuopt{Gruppe hinzufügen}
\item \dropmenuopt{Alles ausklappen}
\item \dropmenuopt{Alles zusammenfalten}
\end{itemize}

Wählen Sie \dropmenuopt{Eigenschaften} aus dem Menü, um die
Rasterlayereigenschaften\index{Rasterlayer!Eigenschaften} anzuzeigen oder 
doppelklicken Sie einfach auf den Namen des Rasterlayers in der Legende. 
Abbildung \ref{fig:raster_properties} zeigt das Dialogfenster
\dialog{Rastereigenschaften} mit verschiedenen Reitern:

\begin{itemize}[label=--]
 \item \tab{Stil}
 \item \tab{Transparenz}
 \item \tab{Farbkarte}
 \item \tab{Allgemein}
 \item \tab{Metadaten}
 \item \tab{Pyramiden}
 \item \tab{Histogramm}
\end{itemize}

\begin{figure}[h]
  \begin{center}
   \caption{Dialogfenster Rasterlayereigenschaften
\nixcaption}\label{fig:raster_properties}\smallskip
   \includegraphics[clip=true, width=14cm]{rasterPropertiesDialog}
\end{center}  
\end{figure}

\subsection{Stil}\label{label_symbology}

QGIS unterstützt zwei unterschiedliche Arten der Darstellung von
Rasterlayern:\index{Rasterlayer!unterstützte Kanäle}

\begin{itemize}[label=--]
\item Einfaches Grauband - Ein Kanal (Band) des Rasterlayers wird in
Graustufen oder definierten Farben dargestellt.
\item Dreibandfarbe - Wenn der Rasterlayer drei oder mehr Kanäle (Bänder)
enthält, werden drei Kanäle des Rasterlayers jeweils als Blau, Grün und Rot
Komponente miteinander kombiniert und als Farbkomposit dargestellt.
\end{itemize}

Für beide Darstellungsvarianten können sie zusätzlich das Kontrollkästchen
\checkbox{Farbabbildung invertieren} auswählen.

\minisec{Einfachbandeigenschaften}

In diesem Bereich gibt es zwei Auswahlmöglichkeiten. Als erstes können Sie,
wenn mehrere Kanäle (Bänder) zur Verfügung stehen auswählen, welcher
dargestellt werden soll. Als zweite Option kann die Farbabbildung ausgewählt
werden: 

\begin{itemize}[label=--]
\item Graustufen (Dies ist Standardeinstellung)
\item Pseudofarben
\item Ausgeflippt
\item Farbkarte
\end{itemize}

Wenn Sie den Eintrag \selectstring{Farbabbildung}{Farbkarte} auswählen, wird
der Reiter \tab{Farbkarte} aktiv. Lesen Sie dazu mehr im
Kapitel~\ref{label_colormaptab}.

QGIS kann so eingestellt werden, dass nur Rasterzellen gezeigt werden, die
Werte innerhalb eines definierten Minimum und Maximum oder einer
Standarbweichung zum Mittelwert des Layers enthalten.
\index{Rasterlayer!Standardabweichung} Dies ist nützlich, wenn man Layer 
anzeigen lassen möchte, bei denen einzelne Zellen extrem abweichende Werte 
haben, was einen negativen Einfluss auf die Darstellung in QGIS hat. 
Diese Extrema des Kanals können Sie manuell eingeben, oder statistisch 
schätzen oder genau bestimmen. Außerdem können Sie den Kontrast der 
Kanäle (Bänder) mit folgenden Optionen verbessern:

\begin{itemize}[label=--]
\item Kein Strecken (Dies ist Standardeinstellung)
\item Strecke auf MinMax
\item Strecken und Zuschneiden auf MinMax
\item Zuschneiden auf MinMax
\end{itemize}

\begin{Tip}\caption{\textsc{Einen einzelnen Kanal eines Mehrkanal-Rasterlayers
anzeigen}}Wenn Sie einen einzelnen Kanal (z.B.: den Rot-Kanal) eines
Mehrkanal-Rasterlayers sehen möchten, könnten Sie denken, dass Sie dazu den
Wert für den Blau- und Grünkanal auf 'Nicht gesetzt' stellen sollten. Dies
ist aber nicht der richtige Weg. Setzen Sie hierzu den Bildtyp auf Graustufen
und wählen dann Rot als Kanal, den Sie als Graustufenbild anzeigen möchten.
\end{Tip}

\minisec{Drei-Kanal-Farben}

Wenn Ihr Datensatz mehr als 1 Kanal bereitstellt, können Sie an dieser Stelle 
eine Vielzahl von Einstellungsmöglichkeiten nutzen, um das Erscheinungsbild der 
Rasterkarte zu beeinflussen. Sie können z.B. die Kombination der 
Farbkanäle ändern.

\subsection{Transparenz} \label{rastertab:transparency}

In QGIS können Rasterlayer in unterschiedlicher Transparenz dargestellt
werden.\index{Rasterlayer!Transparenz}. Wählen Sie den Schieberegler
\slider{Globale Transparenz} und stellen Sie ein, in welchem
Ausmaß
darunterliegende Layer im Kartenfenster sichtbar sein sollen. Dies ist z.B.
nützlich für die Darstellung einer 'shaded relief' Ansicht. Neben der
globalen Transparenz können Sie diese auch auf bestimmte Kanäle (Bänder)
und auch Pixelwerte beschränken und Sie können auch Pixelwerte angeben, die
als 'Ohne Wert', also \textit{NoData}-Wert visualisiert werden sollen.
Dies kann manuell definiert werden, oder mit Hilfe des Icons 
\toolbtntwo{mActionContextHelp}{Werte aus Anzeige ergänzen}.

Als Beispiel wollen wir die Wasserflächen aus dem Rasterlayer
\filename{landcover.img} auf eine Transparenz von 50\% setzen. Folgende
Schritte sind dazu notwendig:

\begin{enumerate}
 \item  Laden Sie den Rasterlayer \filename{landcover.img} aus dem Alaska
Beispieldatensatz
 \item Öffnen Sie den Dialog \dialog{Rasterlayereigenschaften} indem Sie auf
den Namen \filename{landcover} in der Legende doppelklicken, oder im
Rechte-Maustaste Menü \dropmenuopt{Eigenschaften} auswählen.
 \item Wählen Sie den Reiter \tab{Transparenz}
 \item Klicken Sie auf den Knopf \toolbtntwo{mActionNewAttribute}{Werte
manuell eingeben}. Eine neue Zeile erscheint im Fenster Transparenzpixelliste.
 \item Tragen Sie die Pixelwerte (in diesem Fall 0 ein) und setzen Sie die
Transparenz auf den Wert 50\%
 \item Drücken Sie den Knopf \button{Anwenden} und schauen Sie sich das
Ergebnis an.
\end{enumerate}

Es ist sehr einfach und Sie können diese Schritte beliebig oft wiederholen
und die Werte anpassen. Wenn Sie die passenden Werte gefunden haben, können
Sie diese mit dem Knopf \toolbtntwo{mActionFileSave}{Exportieren in Datei}
speichern bzw. bereits abgespeicherte Werte mit dem Knopf
\toolbtntwo{mActionFolder}{Datei importieren} wieder laden.

\subsection{Farbkarte} \label{label_colormaptab}

Der Reiter \tab{Farbkarte} ist nur aktiv, wenn Sie im Reiter
\tab{Stil} im Bereich Einfachbandeigenschaften als Farbabbildung den
Eintrag Farbkarte gewählt haben (Siehe Kapitel~\ref{label_sombology}).

Es gibt drei Möglichkeiten der Farbinterpolation: 

\begin{itemize}[label=--]
\item Diskret
\item Linear 
\item Genau
\end{itemize}

Der Knopf \button{Eintrag hinzufügen} ergänzt eine Farbe zur individuellen
Farbtabelle. Indem Sie auf einen Wert innerhalb der Spalte Value drücken,
können Sie einen bestimmten Pixelwert eintragen. Wenn Sie dann daneben auf
das Feld in der Spalte Farbe klicken öffnet sich der Dialog
\dialog{Farbauswahl} und Sie können dem Pixelwert eine Farbe zuweisen. Mit 
dem Knopf \button{Eintrag löschen} können Sie einzelne Farbwerte wieder 
löschen und mit \button{Sortieren} die Einträge sortieren.

Alternativ können Sie auch auf den Knopf
\toolbtntwo{mActionFileOpen}{Farbabbildung aus Kanal laden} drücken, um eine
Farbtabelle aus einer bereits vorhandenen Datei zu laden. In dem Bereich
'Neue Farbabbildung generieren' können Sie eine neue Farbtabelle mit
definierten Klassen erstellen. Wählen Sie dazu eine
\selectnumber{Eintragsanzahl}{14} und drücken Sie auf den Knopf
\button{Klassifizieren}. Aktuell steht der 
\selectstring{Klassifikationsmodus}{Gleiches Intervall} zur Verfügung.
\index{Rasterlayer!Klassifizierung}.

\subsection{Allgemein}\label{label_generaltab}

Im Reiter \tab{Allgemein} werden allgemeine Informationen zum ausgewählten
Rasterlayer angezeigt, wie der Name und Quellpfad des Rasters (kann geändert
werden). Außerdem wird ein Thumbnail der Karte gezeigt, die Legende sowie die
Farbpalette.\index{Rasterlayer!Layereigenschaften}

Zusätzlich kann eine skalenabhängige Sichtbarkeit eingestellt werden. Dazu
muss das Kontrollkästchen \checkbox{Maßstababhängige Sichtbarkeit} aktiviert
und ein entsprechender Maßstab eingetragen werden.

Außerdem können Sie das \guiheading{Koordinatenbezugssystem} als
PROJ.4 Text ablesen und mit dem Knopf \button{Ändern} verändert.

\subsection{Metadaten}\label{label_metatab}

Der Reiter \tab{Metadaten} zeigt eine Anzahl von Informationen über den
Rasterlayer, inklusive Statistiken über jeden Kanal (Band) innerhalb des
Layers. Statistiken werden nach dem Prinzip 'was brauche ich' erstellt. Es
kann also gut sein, dass für einen Rasterlayer keine Statistik zur Verfügung
steht oder gesammelt wurde.\index{Rasterlayer!Metadaten}

Wie Sie sehen, kann man in diesem Reiter bisher keine Informationen ändern.
Um die Statistik des Rasterlayers zu aktualisieren, wechseln Sie in den
Reiter \tab{Histogramm} und klicken auf den Knopf \button{Erneuern} (Siehe
auch Kapitel~\ref{raster_histogram})

\subsection{Pyramiden}\label{raster_pyramids}

Hochaufgelöste Rasterlayer können das Navigieren in QGIS verlangsamen. Indem
Sie geringer aufgelöste Kopien (Pyramiden) erstellen, kann die Darstellung
optimiert werden. QGIS wählt dann ensprechend des Zoom-Levels die passende
Auflösung.
\index{Rasterlayer!Pyramiden erstellen}
Sie brauchen dazu Schreibrecht in dem Ordner, in dem sich sie Originaldaten
befinden und können dann zwischen verschiedenen Resampling-Methoden wählen:

\begin{itemize}[label=--]
\item Durchschnitt
\item Nächster Nachbar
\end{itemize}

Außerdem können Sie das Kontrollkästchen \checkbox{Wenn möglich interne
Pyramiden erzeugen} auswählen. Falls es das Datenformaterlaubt, werden die
zusätzlichen Informationen dann in den Ausgangslayer geschrieben und nicht in
eine Extradatei. Bitte beachten Sie, dass das Erstellen von Pyramiden die Originaldaten
verändern und dieser Schritt nicht mehr rückgängig gemacht werden kann. Wenn
Sie eine 'nicht pyramidisierte' Version der Daten wünschen, erstellen Sie
vorher eine Kopie.

\subsection{Histogramm}\label{raster_histogram}

Der Reiter \tab{Histogramm} erstellt ein Histogramm der Werteverteilung
eines Rasterlayers.\index{Rasterlayer!Histogramm}. Das Histogramm wird 
automatisch erstellt, wenn man den Reiter öffnet.

%\begin{itemize}[label=--]
%\item Balkendiagramm
%\item Kurvendiagramm
%\end{itemize}
%
%Klicken Sie dazu erst auf den Knopf \button{Erneuern} und wählen Sie dann die
%Kanäle (falls mehrere vorhanden sind) aus, die angezeigt werden sollen.
%Die Berechneten Werte werden dann auch in dem Reiter \tab{Metadaten}
%ergänzt.\index{Rasterlayer|)} Zusätzlich können Sie noch die Anzahl der
%Diagrammspalten festlegen und
%auswählen, ob \checkbox{Bereichsüberschreitung erlaubt} ist, oder ob Sie
%\checkbox{Approximation erlauben}.

\begin{Tip}\caption{\textsc{Statistikwerte für Rasterlayer sammeln}}
Um statistische Informationen klicken Sie auf \texttt{Erneuern}.
Dieser Vorgang kann zeitaufwendig sein. Bitte seien Sie geduldig, während
QGIS Daten sammelt!\index{Rasterlayer!Statistik}
\end{Tip}

\section{Rasterrechner}\label{sec:raster_calc}
\index{Raster!Rasterrechner}
\index{Rasterrechner}

Der \dialog{Rasterrechner} im Menü \mainmenuopt{Layer} ermöglicht 
Rechenoperationen auf Basis von Pixelwerten einer in QGIS geladenen Rasterkarte. 
Das Ergebnis wird als neue Rasterkarte abgespeichert. Das Format kann entsprechend 
der durch GDAL unterstützten Formate festgelegt werden. 

\begin{figure}[ht]
  \centering
    \includegraphics[clip=true, width=11.5cm]{raster_calculator}
    \caption{Rasterrechner \nixcaption}\label{fig:raster_calculator}
\end{figure}

Im Bereich \textbf{Rasterkanäle} sind alle geladenen Rasterlayer aufgelistet, 
die für die Berechnungen verwendet werden können. Um ein Raster in das 
Rasterrechnerausdruck Fenster einzufügen, doppelklicken Sie einfach auf dessen 
Namen. Sie können dann mit den Operatoren Ausdrücke per Mausklick konstruieren 
oder manuell in die Box eingeben.

Im Bereich \textbf{Ergebnislayer} müssen Sie einen Ausgabelayer definieren. 
Sie können dann definieren den Analysebereich auf Grundlage eines Eingaberasters 
oder basierend auf Min/Max X und Y-Koordinaten bzw. mittels Spalten und Zeilen 
angeben, um die Auflösung des Ausgabelayer festzulegen. Wenn die Eingabelayer 
eine abweichende Auflösung besitzen, werden die Werte auf Basis des nearest 
neighbor Algorithmus resampelt.

Der Bereich \textbf{Operatoren} stellt Operatoren für die Berechnungen bereit. 
Um einen Operator auszuwählen, klicken Sie auf die entsprechende Schaltfläche. 
Derzeit stehen einige mathematische Berechnungen (+, -, * \dots) sowie 
trigonometrische Funktionen (sin, cos, tan, \dots) zur Verfügung. Die Anzahl wird 
mit den nächsten Versionen sicherlich noch wachsen.

Mit dem Kontrollkästchen \checkbox{Ergebnis zum Projekt hinzufügen} wird der 
Ergebnislayer automatisch im QGIS Kartenfenster visualisiert. 

\section{Rasteranalysen}\label{sec:raster_analysis}
\index{Raster!Rasteranalyse}
\index{Rasteranalyse}

Abgesehen vom Rasterrechner werden alle weiteren Rasteranalysen durch das 
GDAL Tools Plugin (siehe Kapitel \ref{label_plugingdaltools}) und ein paar 
weitere externe Python Plugins bereitgestellt.  

\FloatBarrier
