% working with OGC-data
\section{Working with OGC Data}

QGIS supports WMS and WFS as data sources. The support is native; WFS is
implemented as a plugin.

\subsection{What is OGC Data}\index{OGC!introduction}

The Open Geospatial Consortium (OGC), is an international organization with more than 300 
commercial, governmental, nonprofit and research organisations worldwide. Its members 
develop and implement standards for geospatial content and services, GIS data processing 
and exchange.

Describing a basic data model for geographic features an increasing number of specifications 
are developed to serve specific needs for interoperable location and geospatial technology, 
including GIS. Further information can be found under \url{http://www.opengeospatial.org/}.

Important OGC specifications are:

\begin{itemize}
\item \textbf{WMS} - Web Map Service
\item \textbf{WFS} - Web Feature Service
\item \textbf{WCS} - Web Coverage Service
\item \textbf{CAT} - Web Catalog Service
\item \textbf{SFS} - Simple Features for SQL
\item \textbf{GML} - Geography Markup Language
\end{itemize}

OGC services are increasingly being used to exchange geospatial data between
different GIS implementations and data stores.  QGIS can now deal with three of the
above specifications, being SFS (though support of the PostgreSQL / PostGIS
data provider, see Section \ref{label_postgis}); WFS and WMS as a client.

\subsection{WMS Client}\label{sec:ogc-wms}\index{WMS!client}\index{OGC!WMS!client}\index{rasters!WMS}

\subsubsection{Overview of WMS Support}\label{sec:ogc-wms-about}\index{WMS!client!about}

QGIS currently can act as a WMS client that understands WMS 1.1, 1.1.1 and 1.3
servers.  It has particularly been tested against publicly accessible servers
such as DEMIS and JPL OnEarth.

WMS servers act upon requests by the client (e.g. QGIS) for a raster map with
a given extent, set of layers, symbolisation style, and transparency.  The WMS
server then consults its local data sources, rasterizes the map, and sends
it back to the client in a raster format.  For QGIS this would typically
be JPEG or PNG.

WMS is generically a REST (Representational State Transfer) service rather than
a fully-blown Web Service.  As such, you can actually take the URLs generated by
QGIS and use them in a web browser to retrieve the same images that QGIS uses
internally.  This can be useful when troubleshooting problems, as there are
several brands of WMS servers in the market and they all have their own
interpretation of the WMS standard.

WMS layers can be added quite simply, as long as you know the URL to access
the WMS server, you have a serviceable connection to that server, and the
server understands HTTP as the data transport mechanism.

\subsubsection{Selecting WMS Servers}\label{sec:ogc-wms-servers}\index{WMS!remote server!selection}

The first time you use the WMS feature, there are no servers defined. You 
can begin by clicking the \toolbtntwo{mActionAddWmsLayer}{Add WMS layer} button inside the toolbar, 
or through the \mainmenuopt{Layer}>\dropmenuopttwo{mActionAddWmsLayer}{Add
WMS Layer...} menu.

The dialog for adding layers from the WMS server pops up. Fortunately you can 
add some servers to play with by clicking the \button{Add default servers} 
button. This will add at least three WMS servers for you to use, including the NASA (JPL) 
WMS server. To define a new WMS server in the \tab{Server Connections} section, 
select \button{New}. Then enter in the parameters to connect to your desired
WMS server, as listed in table \ref{tab:wms_connection_parms}:

\begin{table}[ht]\index{WMS!client!connection parameters}
\centering
\caption{WMS Connection Parameters}\label{tab:wms_connection_parms}\medskip
 \begin{tabular}{|l|p{5in}|}
\hline Name & A name for this connection.  This name will be used in the
 Server Connections drop-down box so that you can distinguish it from
 other WMS Servers. \\
\hline URL \index{WMS!URL} & URL of the server providing the data.
 This must be a resolvable host name; the same format as you would use 
 to open a telnet connection or ping a host. \\
\hline Proxy Host & Network address or host name of the proxy server
 you would use to access this WMS server, or leave blank if no proxy is needed. \\
\hline Proxy Port & Port number of the proxy server. \\
\hline Proxy User & User name used to login to the proxy server. \\
\hline Proxy Password & Password used to login to the proxy server. \\
\hline
\end{tabular}
\end{table}

At least \fieldname{Name} and \fieldname{URL} are required entries; the
\fieldname{proxy} entries 
can be left blank if you have a clear path to your WMS server.

Once the new WMS Server has been created, it will be preserved across future 
QGIS sessions.

\begin{Tip}[ht]\caption{\textsc{On WMS Server URLs}}
\qgistip{Be sure, when entering in the WMS server URL, that you have
the base URL.  For example, you shouldn't have fragments such as
\usertext{request=GetCapabilities} or \usertext{version=1.0.0}
in your URL.\index{WMS!remote server!URL}
}
\end{Tip}

Table \ref{tab:wms_example_urls} shows some example WMS URLs to get you started.
These links were last checked in December 2006, but could change at any time:

%FIXME:  WMS URLs should be checked again and maybe extended in QGIS 

\begin{table}[ht]\index{WMS!remote server!URL!examples}
\centering
\caption{Example Public WMS URLs}\label{tab:wms_example_urls}\medskip
 \begin{tabular}{|l|l|}
\hline \textbf{Name}        & \textbf{URL} \\
\hline Atlas of Canada      & http://atlas.gc.ca/cgi-bin/atlaswms\_en? \\
\hline DEMIS                & http://www2.demis.nl/wms/wms.asp?wms=WorldMap\& \\
\hline Geoscience Australia & http://www.ga.gov.au/bin/getmap.pl?dataset=national \\
\hline NASA JPL OnEarth     & http://wms.jpl.nasa.gov/wms.cgi? \\
\hline QGIS Users           & http://qgis.org/cgi-bin/mapserv?map=/var/www/maps/main.map\& \\
\hline
\end{tabular}
\end{table}

An exhaustive list of WMS servers can be found at \url{http://wms-sites.com}.

\subsubsection{Loading WMS Layers}\label{sec:ogc-wms-layers}\index{WMS!client!layers}

Once you have successfully filled in your parameters you can select the
\button{Connect}
button to retrieve the capabilities of the selected server.  This includes the Image encoding,
Layers, Layer Styles, and Projections.  Since this
is a network operation, the speed of the response depends on the quality of your network
connection to the WMS server. While downloading data from the WMS server, the download progress 
is visualized in the left bottom of the WMS Plugin dialog 

Your screen should now look a bit like Figure \ref{fig:connection_wms}, which shows the 
response provided by the NASA JPL OnEarth WMS server.

% \begin{figure}[ht]
\begin{figure}[ht]
  \begin{center}
  	\caption{Dialog for adding a WMS server, showing its available layers}\label{fig:connection_wms}
	\includegraphics[clip=true,width=0.6\textwidth]{connection_wms}
  \end{center}
\end{figure}

\minisec{Image Encoding}

The \tab{Image encoding} section now lists the formats that are supported by both
the client and server.  Choose one depending on your image accuracy requirements.

\begin{Tip}[ht]\caption{\textsc{Image Encoding}}
\qgistip{You will typically find that a WMS server offers you the choice
of JPEG or PNG image encoding.  JPEG is a lossy compression format,
whereas PNG faithfully reproduces the raw raster data.

Use JPEG if you expect the WMS data to be photographic in nature and/or you don't
mind some loss in picture quality.  This trade-off typically reduces by 5 times
the data transfer requirement compared to PNG.

Use PNG if you want precise representations of the original data, and you don't mind
the increased data transfer requirements.
\index{WMS!image encoding}
}
\end{Tip}

\minisec{Layers}

The \tab{Layers} section lists the layers available from the selected
WMS server.  You may notice that some layers are expandible, this means
that the layer can be displayed in a choice of image styles.

You can select several layers at once, but only one image style per layer.
When several layers are selected, they will be combined at the WMS Server
and transmitted to QGIS in one go.

\begin{Tip}[ht]\caption{\textsc{WMS Layer Ordering}}
\qgistip{In this version of QGIS, WMS layers rendered by a server are overlaid
in the order listed in the Layers section, from top to bottom of the list.
If you want to overlay layers in the opposite order, then you can 
select \toolbtntwo{mActionAddWmsLayer}{Add WMS layer} a second time, choose the same server again,
and select the second group of layers that you want to overlay the first group.
\index{WMS!remote server!layer ordering}
}
\end{Tip}

\minisec{Transparency}
% BM: doesn't seem to work?
% \label{ogc-wms-transparency}
In this version of QGIS, the transparency setting is hard-coded to 
be always on, where available.  Therefore no option for it exists
on-screen.

This, in theory, allows you to overlay WMS layers on other layers (raster,
vector or WMS) and still see through to those lower layers.

\begin{Tip}[ht]\caption{\textsc{WMS Layer Transparency}}
\qgistip{The availability of WMS image transparency depends on
the image encoding used:  PNG and GIF support transparency,
whilst JPEG leaves it unsupported.
\index{WMS!layer transparency}
}
\end{Tip}

\minisec{Coordinate Reference System}
\index{WMS!CRS}\index{WMS!coordinate reference system}
\index{OGC!CRS}\index{OGC!coordinate reference system}
\index{Projections!WMS}
\index{Projections!CRS}\index{Projections!coordinate reference system}
\index{CRS}\index{coordinate reference system}

A Coordinate Reference System (CRS) is the OGC terminology for a QGIS Projection.

Each WMS Layer can be presented in multiple CRSs, depending
on the capability of the WMS server.  You may notice that the \textsl{x} changes in
the \textsl{Coordinate Reference System (x available)} header as you
select and deselect layers from the \tab{Layers} section.

To choose a CRS, select \button{Change...} and a screen similar to
Figure \ref{fig:projections} in Section \ref{label_projstart} will appear.
The main difference with the WMS version of the screen is that only
those CRSs supported by the WMS Server will be shown.


\begin{Tip}[ht]\caption{\textsc{WMS Projections}}
\qgistip{For best results, make the WMS layer the first layer
you add in the project.  This allows the project
projection to inherit the CRS you used to render the WMS layer.
On-the-fly projection (see Section \ref{sec:projection-specifying})
can then be used to fit any subsequent
vector layers to the project projection.
In this version of QGIS, if you add a WMS layer later, and give it a different
CRS to the current project projection, unpredictable
results can occur.
}
\end{Tip}


\subsubsection{Using the Identify Tool}\label{sec:ogc-wms-identify}
\index{WMS!identify}
\index{identify!WMS}

Once you have added a WMS server, 
and if any layer from a WMS server is queryable, you can then use
the \toolbtntwo{mActionIdentify}{Identify} tool to select a pixel on the map canvas.
A query is made to the WMS server for each selection made.

The results of the query are returned in plain text.
The formatting of this text is dependent on the particular
WMS server used.


\subsubsection{Viewing Properties}\label{sec:ogc-wms-properties}\index{WMS!properties}
\index{rasters!properties}

Once you have added a WMS server, you can view its properties
by right-clicking on it in the legend, and selecting
\button{Properties}.


\minisec{Metadata Tab}\label{sec:ogc-wms-properties-metadata}
\index{rasters!metadata}
\index{WMS!metadata}
\index{WMS!capabilites}

The \tab{Metadata} tab displays a wealth of information about the WMS server,
generally collected from the Capabilities statement returned from
that server.

Many definitions can be gleaned by reading the WMS
standards \cite{OGCWMS010101web}, \cite{OGCWMS010300web}, but
here are a few handy definitions:

\begin{itemize}
\item \textbf{Server Properties}

\begin{itemize}
\item \textbf{WMS Version}      - The WMS version supported by the server.

\item \textbf{Image Formats}    - The list of MIME-types the server can respond with when
                                  drawing the map.  QGIS supports whatever formats
                                  the underlying Qt libraries were built with, which
                                  is typically at least \texttt{image/png} 
                                  and \texttt{image/jpeg}.

\item \textbf{Identity Formats} - The list of MIME-types the server can respond with when
                                  you use the Identify tool.  Currently QGIS supports
                                  the \texttt{text-plain} type.

\end{itemize}

\item \textbf{Layer Properties}

\begin{itemize}
\item \textbf{Selected}         - Whether or not this layer was selected when its                                                                        server was added to this project.

\item \textbf{Visible}          - Whether or not this layer is selected as visible
                                  in the legend.  (Not yet used in this version of QGIS.)

\item \textbf{Can Identify}     - Whether or not this layer will return any results
                                  when the Identify tool is used on it.

\item \textbf{Can be Transparent} - Whether or not this layer can be rendered with transparency.
                                    This version of 
                                    QGIS will always use transparency if this is \textsl{Yes}
                                    and the image encoding supports transparency
% BM: doesn't seem to work?
%                                    (see Section
%                                    \ref{ogc-wms-transparency}
%                                    ).
                                    .

\item \textbf{Can Zoom In}      - Whether or not this layer can be zoomed in by the server.  This version
                                  of QGIS assumes all WMS layers have this set to \textsl{Yes}.
                                  Deficient layers may be rendered strangely.

\item \textbf{Cascade Count}    - WMS servers can act as a proxy to other WMS servers to get
                                  the raster data for a layer.  This entry shows how
                                  many times the request for this layer is forwarded to peer
                                  WMS servers for a result.

\item \textbf{Fixed Width}, \textbf{Fixed Height}
                                - Whether or not this layer has fixed source pixel dimensions.
                                  This version
                                  of QGIS assumes all WMS layers have this set to nothing.
                                  Deficient layers may be rendered strangely.

\item \textbf{WGS 84 Bounding Box} - The bounding box of the layer, in WGS 84 coordinates.
                                     Some WMS servers do not set this correctly (e.g. UTM
                                     coordinates are used instead).  If this is the case,
                                     then the initial view of this layer may be rendered
                                     with a very ``zoomed-out'' appearance by QGIS.
                                     The WMS webmaster should be informed of this error,
                                     which they may know as the WMS XML elements
                                     \texttt{LatLonBoundingBox},
                                     \texttt{EX\_GeographicBoundingBox} or
                                     the CRS:84 \texttt{BoundingBox}.

\item \textbf{Available in CRS} - The projections that this layer can be rendered in by
                                  the WMS server.  These are listed in the WMS-native format.

\item \textbf{Available in style} - The image styles that this layer can be rendered in by
                                    the WMS server.

\end{itemize}

\end{itemize}


\subsubsection{WMS Client Limitations}\label{sec:ogc-wms-limits}\index{WMS!client!limits}

Not all possible WMS Client functionality had been included in this version of QGIS.
Some of the more notable exceptions follow:

\minisec{Editing WMS Layer Settings}
\index{WMS!layer settings!editing}

Once you've completed the \toolbtntwo{mActionAddWmsLayer}{Add WMS layer}
procedure, there is no ability to change the settings.

A workaround is to delete the layer completely and start again.

\minisec{WMS Servers Requiring Authentication}
\index{WMS!remote server!authentication}

Only public WMS servers are accessible.
There is no ability to apply a user name and password combination
as an authentication to the WMS server.

\subsection{WFS Client}

In QGIS, a WFS layer behaves pretty much like any other vector layer. You 
can identify and select features and view the attribute table. The WFS 
plugin doesn't support editing at this time. 

Adding a WFS layer is very similar to the procedure used with WMS. The
difference is there are no default servers defined, so we have to add our
own.

\subsubsection{Loading a WFS Layer}

As an example we use the DM Solutions WFS server and display a layer. The URL is:
\begin{verbatim}
http://www2.dmsolutions.ca/cgi-bin/mswfs_gmap?VERSION=1.0.0&SERVICE=
wfs&REQUEST=GetCapabilities
\end{verbatim}

\begin{enumerate}
  \item Make sure the WFS plugin is loaded; if not, open the Plugin Manager and load it
  \item Click on the \toolbtntwo{wfs-icon}{Add WFS Layer} tool on the plugins toolbar
  \item Click on \button{New} 
  \item Enter \fieldname{DM Solutions} as the name
  \item Enter the URL (see previous page)
  \item Click \button{OK} 
  \item Choose \fieldname{DM Solutions} from the drop-down box
  \item Click \button{Connect} 
  \item Wait for the list of layers to be populated
  \item Click on the \fieldname{Canadian Land} layer
  \item Click \button{Add} to add the layer to the map
  \item Wait patiently for the features to appear
\end{enumerate}

\begin{figure}[ht]
 \begin{center}
  \caption{Adding a WFS layer}\label{fig:wfs_dmsolutions}
  \includegraphics[clip=true,width=\textwidth]{wfs_dmsolutions}
 \end{center}
\end{figure}

You'll notice the download progress is visualized in the left bottom of the QGIS main window. 
Once the layer is loaded, you can identify and select a province or two and view the 
attribute table.

% FIXME: Is this still true? SH: I think it is stable though.
Remember this plugin is still experimental. You might also experience random behavior 
and crashes. You can look forward to improvements in a future version of the plugin.

\begin{Tip}[ht]\caption{\textsc{Finding WMS and WFS Servers}}
\qgistip{You can find additional WMS and WFS servers by using Google or your
favorite search engine. There are a number of lists, some of them
maintained and some not, that list public servers you can use.
\index{WFS!remote server!}
}
\end{Tip} 
